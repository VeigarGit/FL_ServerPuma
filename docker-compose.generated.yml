version: '3.8'

services:
  server:
    build:
      context: .
      dockerfile: dockerfile.server
      args:
        - NO_CACHE=true
    container_name: fl-server
    ports:
      - "9090:9090"
    command: ["python", "server.py", "--dataset", "MNIST", "--clients-per-round", "3"]
    networks:
      - fl-network

  client: &client
    build:
      context: .
      dockerfile: dockerfile.client
      args:
        - NO_CACHE=true
    image: fl-client-image
    depends_on:
      - server
    networks:
      - fl-network

  client-1:
    <<: *client
    container_name: fl-client-1
    command: ["python", "client.py", "--client-idx", "1", "--host", "fl-server", "--dataset", "MNIST"]

  client-2:
    <<: *client
    container_name: fl-client-2
    command: ["python", "client.py", "--client-idx", "2", "--host", "fl-server", "--dataset", "MNIST"]

  client-3:
    <<: *client
    container_name: fl-client-3
    command: ["python", "client.py", "--client-idx", "3", "--host", "fl-server", "--dataset", "MNIST"]

networks:
  fl-network:
    driver: bridge
